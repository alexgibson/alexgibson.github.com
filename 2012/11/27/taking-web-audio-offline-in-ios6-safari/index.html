<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
  <meta charset="utf-8">
  <title>Taking Web Audio Offline in iOS 6 Safari &ndash; Alex Gibson</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="How to cache audio files for offline use using the Web Audio API">
  <meta name="author" content="Alex Gibson">
  <meta name="generator" content="Jekyll">
  
  <link rel="canonical" href="https://alxgbsn.co.uk/2012/11/27/taking-web-audio-offline-in-ios6-safari/">
  
  <script type="module">
    try {
      const currentPref = sessionStorage.getItem('t-dark');
      const prefersDarkMode = currentPref === 'true' || (currentPref !== 'false' && window.matchMedia('(prefers-color-scheme: dark)').matches);

      if (prefersDarkMode) {
          document.documentElement.classList.add('js-t-dark');
      }

      // remove no-js class that supports dark theme with JS disabled.
      document.documentElement.classList.remove('no-js');
    } catch (e) {
      // do nothing.
    }
  </script>
  <link rel="stylesheet" type="text/css" href="/assets/styles-b020b9a8f36b2ad2ac9fc0251b6c30724d4853bf8bda326059ac8dec0bbf3cfb.css">
  <link rel="alternate" type="application/rss+xml" title="Alex Gibson" href="/feed/">
  <link rel="manifest" href="/manifest.json">
  <!--[if lt IE 9]>
    <script type="text/javascript" src="/assets/lib/html5shiv-6e9566e51098627c2824e546909ee18725d233fc9cdd81910819e7e108cf36c0.js"></script>
  <![endif]-->
  <meta name="apple-mobile-web-app-title" content="Alex Gibson">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/avatar-180-b1f192dbbe4ceec9c13c327fb0908af5ddbf621002116885f0cc2e8d8b6787c8.jpg">
  <link rel="icon" type="image/png" sizes="196x196" href="/assets/avatar-196-a65772ff09fa529d865e4f60735ded2bfb50711bafb1bd79cb2111d7c4ec461c.jpg">
  <link rel="shortcut icon" href="/assets/favicon-28523dd6d2b5917829586fe5248f9a408486e09f98117add94210f56aa7ead33.ico">
</head>
<body id="top">
  <main role="main">
    <div class="masthead">
  <nav role="navigation">
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/about/">About</a></li>
      <li><a href="/contact/">Contact</a></li>
    </ul>
  </nav>

  <div class="theme-selector hidden">
    <form class="theme-form" method="get">
      <input type="checkbox" id="theme" name="theme">
      <label for="theme" title="Toggle dark theme">Dark theme</label>
    </form>
  </div>
</div>

    <article>
      <header role="banner">
        <h1>Taking Web Audio Offline in iOS 6 Safari</h1>
      </header>
      <section class="post">
  <p class="meta">
    <time datetime="2012-11-27">November 27 2012</time>
    


3 min
 read.
  </p>
  <p>The following words are from of my first <a href="http://html5doctor.com/author/alexg/">guest post for HTML5 Doctor</a>. You can read the <a href="http://html5doctor.com/taking-web-audio-offline-in-ios-6-safari/">original article here</a>.</p>

<p>Playing cached audio for off-line use on iOS Safari has long been a challenge that has proved to be mission impossible. With the advent of the <a href="https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html">Web Audio API</a> however, it is now finally achievable (despite still needing to jump through a few hoops).</p>

<p>The bad news is that you still can’t cache an MP3 file using <a href="http://html5doctor.com/go-offline-with-application-cache/">Application Cache</a>, and then simply load it using an <code class="language-plaintext highlighter-rouge">XmlHttpRequest</code>. Safari on iOS6 will cache the MP3, but then refuse to play it and fail silently (how useful!). But all is not lost…</p>

<h2 id="base64-to-the-rescue">Base64 to the rescue</h2>

<p>Because the Web Audio API offers developers direct control over the <a href="https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html#AudioBufferSourceNode">audioBuffer</a>, it means you can now convert data formats on-the-fly and then feed it directly to the Web Audio API for playback. For example, if you encode an MP3 file as a base64 string, you can then decode it to an <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays/ArrayBuffer">arrayBuffer</a> and convert the raw audio data.</p>

<h2 id="encoding-an-audio-file">Encoding an audio file</h2>

<p>You can easily convert an mp3 file to a base64 string using <a href="http://www.openssl.org/">OpenSSL</a>. If you are on Mac OSX it comes pre-installed, so just open up Terminal and type the following command. Make sure to replace <code class="language-plaintext highlighter-rouge">&lt;infile&gt;</code> with the path to your mp3, and <code class="language-plaintext highlighter-rouge">&lt;outfile&gt;</code> with your chosen destination for the encoded data.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl base64 -in &lt;infile&gt; -out &lt;outfile&gt;
</code></pre></div></div>

<p>This will output a base64 string representation of your sound file. You can then cache the string using any form of web storage you choose (e.g. <a href="http://html5doctor.com/go-offline-with-application-cache/">Application Cache</a>, <a href="http://html5doctor.com/storing-data-the-simple-html5-way-and-a-few-tricks-you-might-not-have-known/">localStorage</a>, <a href="http://html5doctor.com/introducing-web-sql-databases/">webSQL</a>)</p>

<h2 id="base64-to-arraybuffer">Base64 to arrayBuffer</h2>

<p>In order to decode the base64 string back into an <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays/ArrayBuffer">arrayBuffer</a>, you will need to use a custom method. Check out Daniele Guerrero’s <a href="https://github.com/danguer/blog-examples/blob/master/js/base64-binary.js">base64-binary.js</a> as a good script that can be used exactly for this purpose. It decodes a base64 string into a <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays/Uint8Array">Uint8Array</a> typed array and stores it in an <code class="language-plaintext highlighter-rouge">arrayBuffer</code>. Once this is done, it is then simply a case of decoding the audio data using the Web Audio API’s <code class="language-plaintext highlighter-rouge">decodeAudioData()</code> method.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">arrayBuff</span> <span class="o">=</span> <span class="nx">Base64Binary</span><span class="p">.</span><span class="nx">decodeArrayBuffer</span><span class="p">(</span><span class="nx">sound</span><span class="p">);</span>

<span class="nx">myAudioContext</span><span class="p">.</span><span class="nx">decodeAudioData</span><span class="p">(</span><span class="nx">arrayBuff</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">audioData</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">myBuffer</span> <span class="o">=</span> <span class="nx">audioData</span><span class="p">;</span>
<span class="p">});</span></code></pre></figure>

<p>Once you have the audio data decoded, it is just a case of passing it to your audio buffer source and playing the sound.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">mySource</span> <span class="o">=</span> <span class="nx">myAudioContext</span><span class="p">.</span><span class="nx">createBufferSource</span><span class="p">();</span>
<span class="nx">mySource</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">myBuffer</span><span class="p">;</span>
<span class="nx">mySource</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">myAudioContext</span><span class="p">.</span><span class="nx">destination</span><span class="p">);</span>
<span class="nx">mySource</span><span class="p">.</span><span class="nx">noteOn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></code></pre></figure>

<h2 id="full-demo-and-source-code">Full demo and source code</h2>

<p>Check out the <a href="https://alexgibson.github.io/offlinewebaudio">on-line demo</a> and <a href="https://github.com/alexgibson/offlinewebaudio">source code</a> for a complete example of the techniques discussed in this article.</p>

<h2 id="browser-support">Browser support</h2>

<p>Currently the demo works in Safari 6, Chrome desktop and iOS6 Safari. The technique has potential to work in any browser that supports Web Audio API however, so hopefully Chrome Mobile can soon add support as well.</p>

<p>The W3C is currently pursuing the Web Audio API <a href="http://www.w3.org/2011/audio/wiki/W3C_Audio_Publications_and_Milestones">as a standard</a>.</p>

  <p class="scroll-to-top"><a href="#top">Scroll to top</a></p>
</section>

    </article>
    <footer role="contentinfo">
  <form role="search" class="search" action="https://duckduckgo.com/" method="get" title="Search this site">
    <label for="q">Search</label>
    <input type="hidden" name="sites" value="alxgbsn.co.uk" />
    <input class="search" type="search" name="q" id="q" placeholder="Search this site" />
    <button type="submit">Go</button>
  </form>
  <ul>
    <li><a href="/feed/index.xml" title="RSS feed">Subscribe (RSS)</a></li>
  </ul>
</footer>

  </main>
  <script type="module" src="/assets/theme-77026091a174da81bd4e08d59206f16043046cb6f5d13d856dfc667c7d57987b.js"></script>
  <script type="module" src="/assets/main-e720254e216df6f38df9183d48fc5096b498cf7aa00bfdf57bf8aa71c31a7980.js"></script>
</body>
</html>

/*
 * 
 * Tomb Raider Music Mixer
 * Web Audio API programming by Alex Gibson 2013
 * http://alxgbsn.co.uk | @alex_gibson
 * 
 *//*global clearInterval: false, clearTimeout: false, document: false, event: false, frames: false, history: false, Image: false, location: false, name: false, navigator: false, Option: false, parent: false, screen: false, setInterval: false, setTimeout: false, window: false, XMLHttpRequest: false, console: false, webkitAudioContext: false, AudioContext: false, requestAnimationFrame: false, Uint8Array: false */var TRMixer=function(){"use strict";var e,t,n,r,i,s,o,u,a={},f,l,c,h="brass.mp3",p="high-perc.mp3",d="low-perc.mp3",v="strings.mp3",m="sounds/";return{init:function(){var e=document;if("webkitAudioContext"in window)f=new webkitAudioContext;else{if(!("AudioContext"in window)){console.error("Your device does not yet support the Web Audio API");return}f=new AudioContext}e.getElementById("play").addEventListener("click",TRMixer.playSounds,!1);e.getElementById("stop").addEventListener("click",TRMixer.stopSounds,!1);TRMixer.loadSoundFile(m+h,1);TRMixer.loadSoundFile(m+p,2);TRMixer.loadSoundFile(m+d,3);TRMixer.loadSoundFile(m+v,4);a.volumeBrass=f.createGainNode();a.volumeHighPerc=f.createGainNode();a.volumeLowPerc=f.createGainNode();a.volumeStrings=f.createGainNode();a.masterVolume=f.createGainNode();l=f.createAnalyser();l.smoothingTimeConstant=.85;TRMixer.animateSpectrum();e.addEventListener("touchmove",function(e){if(e.target.type==="range")return;e.preventDefault()},!1);e.addEventListener("touchstart",function(){},!1)},loadSoundFile:function(e,t){var n=new XMLHttpRequest;n.open("GET",e,!0);n.responseType="arraybuffer";n.onload=function(n){console.log("Sound file loaded: ",e);TRMixer.initSound(this.response,t)};n.send()},initSound:function(e,t){f.decodeAudioData(e,function(e){switch(t){case 1:i=e;break;case 2:s=e;break;case 3:o=e;break;case 4:u=e}console.log("Sound file decoded: ",e);if(i&&s&&o&&u){TRMixer.initMixer();console.log("Mixer -> Ready")}},function(e){console.error("Error decoding file",e);document.getElementById("status").innerHTML="Status: Error loading sounds"})},initMixer:function(){var e=document,t=e.getElementById("brass"),n=e.getElementById("high-perc"),r=e.getElementById("low-perc"),i=e.getElementById("strings");e.getElementById("status").innerHTML="Status: Ready";e.getElementById("play").removeAttribute("disabled");e.getElementById("stop").removeAttribute("disabled");t.addEventListener("input",TRMixer.sliderChange,!1);n.addEventListener("input",TRMixer.sliderChange,!1);r.addEventListener("input",TRMixer.sliderChange,!1);i.addEventListener("input",TRMixer.sliderChange,!1);t.removeAttribute("disabled");n.removeAttribute("disabled");r.removeAttribute("disabled");i.removeAttribute("disabled")},routeSounds:function(){var c=document;e=f.createBufferSource();e.buffer=i;e.loop=!0;t=f.createBufferSource();t.buffer=s;t.loop=!0;n=f.createBufferSource();n.buffer=o;n.loop=!0;r=f.createBufferSource();r.buffer=u;r.loop=!0;a.volumeBrass.gain.value=c.getElementById("brass").value;a.volumeHighPerc.gain.value=c.getElementById("high-perc").value;a.volumeLowPerc.gain.value=c.getElementById("low-perc").value;a.volumeStrings.gain.value=c.getElementById("strings").value;a.masterVolume.gain.value=1;e.connect(a.volumeBrass);t.connect(a.volumeHighPerc);n.connect(a.volumeLowPerc);r.connect(a.volumeStrings);a.volumeBrass.connect(a.masterVolume);a.volumeHighPerc.connect(a.masterVolume);a.volumeLowPerc.connect(a.masterVolume);a.volumeStrings.connect(a.masterVolume);a.masterVolume.connect(l);l.connect(f.destination)},playSounds:function(){f.activeSourceCount>0&&TRMixer.stopSounds();TRMixer.routeSounds();e.noteOn(0);t.noteOn(0);n.noteOn(0);r.noteOn(0);console.log("Mixer -> Playing")},stopSounds:function(){if(f.activeSourceCount>0){e.noteOff(0);t.noteOff(0);n.noteOff(0);r.noteOff(0);console.log("Mixer -> Stopped")}},sliderChange:function(e){if(f.activeSourceCount>0)switch(e.target.id){case"brass":a.volumeBrass.gain.value=e.target.value;break;case"high-perc":a.volumeHighPerc.gain.value=e.target.value;break;case"low-perc":a.volumeLowPerc.gain.value=e.target.value;break;case"strings":a.volumeStrings.gain.value=e.target.value}},animateSpectrum:function(){c=requestAnimationFrame(TRMixer.animateSpectrum,document.getElementById("spectrum-output"));TRMixer.drawSpectrum()},drawSpectrum:function(){var e=document.querySelector("canvas"),t=e.getContext("2d"),n=250,r=n,i=n,s=10,o=Math.round(r/s),u=new Uint8Array(l.frequencyBinCount),a,f;e.width=n-10;e.height=n-10;t.clearRect(0,0,r,i);t.fillStyle="#333";l.getByteFrequencyData(u);for(f=0;f<o;f+=1){a=u[f];t.fillRect(s*f,i,s-1,-a)}}}}();window.addEventListener("DOMContentLoaded",TRMixer.init,!0);